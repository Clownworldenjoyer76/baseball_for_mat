name: 03 Batter Adjustments
true:
  workflow_dispatch: null
  workflow_run:
    workflows:
    - 02 Weather Pipeline
    types:
    - completed
    branches:
    - main
permissions:
  contents: write
  actions: write
jobs:
  batter_adjustments:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
    - name: Configure Git
      run: 'git config user.name "github-actions"

        git config user.email "github-actions@github.com"

        '
    - uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-py-${{ hashFiles('requirements.txt') }}
        restore-keys: ${{ runner.os }}-py-
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install deps
      run: 'python -m pip install --upgrade pip

        pip install -r requirements.txt

        '
    - name: Run stage with unified logs
      shell: bash
      run: "set +e\nmkdir -p summaries/batters_adjust\nSTATUS=\"summaries/batters_adjust/status.txt\"\
        \nLOG=\"summaries/batters_adjust/log.txt\"\nERR=\"summaries/batters_adjust/errors.txt\"\
        \nSUM=\"summaries/batters_adjust/summary.txt\"\n: >\"$STATUS\"; : >\"$LOG\"\
        ; : >\"$ERR\"; : >\"$SUM\"\n\nts(){ TZ=\"America/New_York\" date +\"%Y-%m-%d\
        \ %I:%M:%S %p %Z\"; }\nrun_step(){ echo \"\u25B6\uFE0F START: $1 ($(ts))\"\
        \ >>\"$LOG\"; shift; \"$@\" >>\"$LOG\" 2>step.err; rc=$?; if [ $rc -eq 0 ];\
        \ then echo \"\u2705 $1 succeeded [$(ts)]\" >>\"$STATUS\"; else echo \"\u274C\
        \ $1 failed [$(ts)]\" >>\"$STATUS\"; { echo \"\u274C $1 ERROR [$(ts)]:\";\
        \ cat step.err; echo; echo '---'; echo; } >>\"$ERR\"; fi; rm -f step.err;\
        \ echo \"\u23F9\uFE0F END: $1 ($(ts))\" >>\"$LOG\"; echo >>\"$LOG\"; }\n\n\
        run_step apply_weather_adjustment.py       python scripts/apply_weather_adjustment.py\n\
        run_step apply_park_adjustment.py          python scripts/apply_park_adjustment.py\n\
        run_step combine_batter_weather_park.py    python scripts/combine_batter_weather_park.py\n\
        \n{\n  echo \"===== RUN TIMESTAMP: $(ts) =====\"\n  echo; echo \"===== STATUS\
        \ =====\";  cat \"$STATUS\"\n  echo; echo \"===== LOG =====\";     cat \"\
        $LOG\"\n  echo; echo \"===== ERRORS =====\";  cat \"$ERR\"\n} > \"$SUM\"\n"
    - name: Commit stage outputs
      run: 'git add data/adjusted/batters_*_weather.csv || true

        git add data/adjusted/batters_*_park.csv || true

        git add data/adjusted/batters_*_weather_park.csv || true

        git add summaries/batters_adjust/* || true

        git diff --cached --quiet || git commit -m "03 batter adjustments outputs"

        git pull --rebase origin main || true

        git push origin HEAD:main || true

        '
'on':
  workflow_dispatch: {}
  workflow_run:
    workflows:
    - 02 Weather Pipeline
    types:
    - completed
