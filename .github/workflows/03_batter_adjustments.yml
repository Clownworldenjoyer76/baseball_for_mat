name: 03 Batter Adjustments

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["02 Weather Pipeline"]
    types: [completed]

permissions:
  contents: write
  actions: write

jobs:
  batter_adjustments:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py-${{ hashFiles('requirements.txt') }}
          restore-keys: ${{ runner.os }}-py-

      - uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run stage with unified logs
        shell: bash
        run: |
          set +e
          mkdir -p summaries/batters_adjust
          STATUS="summaries/batters_adjust/status.txt"
          LOG="summaries/batters_adjust/log.txt"
          ERR="summaries/batters_adjust/errors.txt"
          SUM="summaries/batters_adjust/summary.txt"
          : >"$STATUS"; : >"$LOG"; : >"$ERR"; : >"$SUM"

          ts(){ TZ="America/New_York" date +"%Y-%m-%d %I:%M:%S %p %Z"; }
          run_step(){ echo "▶️ START: $1 ($(ts))" >>"$LOG"; shift; "$@" >>"$LOG" 2>step.err; rc=$?; if [ $rc -eq 0 ]; then echo "✅ $1 succeeded [$(ts)]" >>"$STATUS"; else echo "❌ $1 failed [$(ts)]" >>"$STATUS"; { echo "❌ $1 ERROR [$(ts)]:"; cat step.err; echo; echo '---'; echo; } >>"$ERR"; fi; rm -f step.err; echo "⏹️ END: $1 ($(ts))" >>"$LOG"; echo >>"$LOG"; }

          run_step apply_weather_adjustment.py  python scripts/apply_weather_adjustment.py
          run_step apply_park_adjustment.py     python scripts/apply_park_adjustment.py
          run_step combine_weather_park_home.py python scripts/combine_weather_park_home.py
          run_step combine_weather_park_away.py python scripts/combine_weather_park_away.py

          {
            echo "===== RUN TIMESTAMP: $(ts) ====="
            echo; echo "===== STATUS =====";  cat "$STATUS"
            echo; echo "===== LOG =====";     cat "$LOG"
            echo; echo "===== ERRORS =====";  cat "$ERR"
          } > "$SUM"

      - name: Commit stage outputs
        run: |
          git add data/adjusted/batters_*_weather.csv || true
          git add data/adjusted/batters_*_park.csv || true
          git add data/adjusted/batters_*_adjusted.csv || true
          git add summaries/batters_adjust/* || true
          git diff --cached --quiet || git commit -m "03 batter adjustments outputs"
          git pull --rebase origin main || true
          git push origin HEAD:main || true

      - name: Trigger 04 Pitcher Adjustments
        if: ${{ success() && github.ref_name == 'main' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          curl -sSf -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/04_pitcher_adjustments.yml/dispatches \
            -d '{"ref":"main"}'
