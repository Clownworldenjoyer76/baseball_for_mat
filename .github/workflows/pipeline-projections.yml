name: "Pipeline Projections (06–07)"

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - "Pipeline Prep (00–05)"
    types:
      - completed

permissions:
  contents: write

concurrency:
  group: pipeline-projections-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: "06 Projection and Builder"
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Setup Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Reset summaries (06)
        run: |
          rm -rf summaries/06_projection
          mkdir -p summaries/06_projection

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight headers
        run: |
          echo ">> HEADERS (todaysgames_normalized.csv)"; (head -n1 data/raw/todaysgames_normalized.csv || true)
          echo ">> HEADERS (startingpitchers_with_opp_context.csv)"; (head -n1 data/raw/startingpitchers_with_opp_context.csv || true)
          echo ">> HEADERS (pitchers_normalized_cleaned.csv)"; (head -n1 data/cleaned/pitchers_normalized_cleaned.csv || true)

      # ---- 06 scripts ----
      - name: 06-01 fix_outputs_generate_fixed_files.py
        run: |
          python scripts/fix_outputs_generate_fixed_files.py |& tee summaries/06_projection/fix_outputs_generate_fixed_files.py.log || true

      - name: 06-02 normalize_inputs_for_06.py
        run: |
          python scripts/normalize_inputs_for_06.py |& tee summaries/06_projection/normalize_inputs_for_06.py.log || true

      - name: 06-03 project_prep.py
        run: |
          python scripts/project_prep.py |& tee summaries/06_projection/project_prep.py.log || true

      - name: 06-04 fix_missing_batter_stats.py
        run: |
          python scripts/fix_missing_batter_stats.py |& tee summaries/06_projection/fix_missing_batter_stats.py.log || true

      - name: 06-05 normalize_batters_for_builder.py
        run: |
          python scripts/normalize_batters_for_builder.py |& tee summaries/06_projection/normalize_batters_for_builder.py.log || true

      - name: 06-06 project_batter_props.py
        run: |
          python scripts/project_batter_props.py |& tee summaries/06_projection/project_batter_props.py.log || true

      - name: 06-07 project_pitcher_props.py
        run: |
          python scripts/project_pitcher_props.py |& tee summaries/06_projection/project_pitcher_props.py.log || true

      - name: 06-08 ensure_pitcher_props_schema.py
        run: |
          python scripts/ensure_pitcher_props_schema.py |& tee summaries/06_projection/ensure_pitcher_props_schema.py.log || true

      - name: 06-09 inject_pitcher_context.py
        run: |
          python scripts/inject_pitcher_context.py |& tee summaries/06_projection/inject_pitcher_context.py.log || true

      - name: 06-10 inject_pitcher_context_from_tgn.py
        run: |
          python scripts/inject_pitcher_context_from_tgn.py |& tee summaries/06_projection/inject_pitcher_context_from_tgn.py.log || true

      - name: 06-11 build_expanded_batter_props.py
        run: |
          python scripts/build_expanded_batter_props.py |& tee summaries/06_projection/build_expanded_batter_props.py.log || true

      - name: 06-12 pitcher_mega_z.py
        run: |
          python scripts/pitcher_mega_z.py |& tee summaries/06_projection/pitcher_mega_z.py.log || true

      - name: 06-13 starter_coverage_guard.py
        run: |
          python scripts/starter_coverage_guard.py |& tee summaries/06_projection/starter_coverage_guard.py.log || true

      - name: 06-14 post_normalize_pitchers.py
        run: |
          python scripts/post_normalize_pitchers.py |& tee summaries/06_projection/post_normalize_pitchers.py.log || true

      - name: 06-15 finalize_projections.py
        run: |
          python scripts/finalize_projections.py |& tee summaries/06_projection/finalize_projections.py.log || true

      - name: 06-16 clean_inject_team_ids.py
        run: |
          python scripts/clean_inject_team_ids.py |& tee summaries/06_projection/clean_inject_team_ids.py.log || true

      - name: 06-17 inject_game_ids_from_schedule.py
        run: |
          python scripts/inject_game_ids_from_schedule.py |& tee summaries/06_projection/inject_game_ids_from_schedule.py.log || true

      - name: 06-18 inject_batter_woba_adjustments.py
        run: |
          python scripts/inject_batter_woba_adjustments.py |& tee summaries/06_projection/inject_batter_woba_adjustments.py.log || true

      - name: 06-19 clean_pitcher_files.py
        run: |
          python scripts/clean_pitcher_files.py |& tee summaries/06_projection/clean_pitcher_files.py.log || true

      - name: 06-20 ensure_pitcher_props_schema.py (end)
        run: |
          python scripts/ensure_pitcher_props_schema.py |& tee summaries/06_projection/ensure_pitcher_props_schema_end.py.log || true

      - name: 06-21 impute_missing_batter_adj_woba.py
        run: |
          python scripts/impute_missing_batter_adj_woba.py |& tee summaries/06_projection/impute_missing_batter_adj_woba.py.log || true

      - name: Commit & push 06 outputs + authoritative CSVs
        if: always()
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add "data/_projections/"*.csv 2>/dev/null || true
          git add "data/end_chain/final/"*.csv 2>/dev/null || true
          git add "data/raw/todaysgames_normalized.csv" 2>/dev/null || true
          git add "data/raw/startingpitchers_with_opp_context.csv" 2>/dev/null || true
          git add "summaries/06_projection/"*.log 2>/dev/null || true
          git commit -m "06 Projection: commit generated outputs and logs" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push || echo "No changes to push"

      - name: Write & push 06 summary
        if: always()
        run: |
          STAGE="summaries/06_projection"
          SUMMARY="$STAGE/summary.txt"
          STATUS="$STAGE/status.txt"
          : > "$STATUS"
          for L in "$STAGE"/*.log; do
            [ -f "$L" ] || continue
            B="$(basename "$L")"
            echo "[OK] ${B} ($(date '+%Y-%m-%d %H:%M:%S %Z'))" >> "$STATUS"
          done
          CLEAN_LOG="$STAGE/clean_pitcher_files.py.log"
          {
            echo "===== RUN TIMESTAMP: $(date '+%Y-%m-%d %H:%M:%S %Z') ====="
            echo
            echo "===== STATUS (per script) ====="
            if [ -s "$STATUS" ]; then cat "$STATUS"; else echo "(status.txt not generated)"; fi
            echo
            echo "===== KEY COUNTS ====="
            if [ -f "$CLEAN_LOG" ]; then
              starters_line=$(grep -E 'Starters seen today:' "$CLEAN_LOG" | tail -n 1 || true)
              if [ -n "$starters_line" ]; then
                echo "starters_today: ${starters_line##*: }"
              else
                echo "starters_today: (not found)"
              fi
            else
              echo "starters_today: (clean_pitcher_files.py.log not found)"
            fi
            echo
            echo "===== LOGS: LAST 20 LINES OF ALL SCRIPT LOGS (current run) ====="
            for LOGF in "$STAGE"/*.log; do
              [ -f "$LOGF" ] || continue
              echo "---- $(basename "$LOGF") ----"
              tail -n 20 "$LOGF"
              echo
            done
          } > "$SUMMARY"
          git add "$SUMMARY" || true
          git commit -m "06 Projection: overwrite summary.txt [skip ci]" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push || echo "No changes to push"

  final_projections:
    name: "07 Final Projections"
    needs: build
    runs-on: ubuntu-latest
    env:
      TZ: America/New_York
      PYTHONUNBUFFERED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Reset summaries (07)
        run: |
          rm -rf summaries/07_final
          mkdir -p summaries/07_final
          : > summaries/07_final/prep_daily_log.txt
          : > summaries/07_final/batter_log.txt
          : > summaries/07_final/pitcher_log.txt
          : > summaries/07_final/game_scores_log.txt
          : > summaries/07_final/summary.txt

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          mkdir -p data/_projections data/end_chain/final

      # NEW: regenerate *_final files if absent (guards against stale repo state)
      - name: Ensure *_final projection CSVs exist
        run: |
          set -euo pipefail
          need=0
          [ -f data/_projections/pitcher_props_projected_final.csv ] || need=1
          [ -f data/_projections/batter_props_projected_final.csv ] || need=1
          [ "$need" -eq 0 ] || python scripts/finalize_projections.py
          ls -l data/_projections | sed 's/^/  /'

      - name: Enforce pitcher props schema (pre-07)
        run: |
          python scripts/ensure_pitcher_props_schema.py
          echo "HEADERS:"; (head -n1 data/_projections/pitcher_props_projected_final.csv || true)

      - name: Prep daily projection inputs
        run: |
          python scripts/prepare_daily_projection_inputs.py | tee -a summaries/07_final/prep_daily_log.txt

      - name: Batter event probabilities
        run: |
          python scripts/project_batter_event_probabilities.py | tee -a summaries/07_final/batter_log.txt

      - name: Pitcher event probabilities
        run: |
          python scripts/project_pitcher_event_probabilities.py | tee -a summaries/07_final/pitcher_log.txt

      - name: Game score projections
        run: |
          rm -f summaries/07_final/gamescores_bad_games.txt || true
          python scripts/project_game_scores.py | tee -a summaries/07_final/game_scores_log.txt

      - name: Summarize run (07)
        run: |
          {
            echo "===== RUN TIMESTAMP: $(date '+%Y-%m-%d %H:%M:%S %Z') ====="
            echo
            echo "===== LOG TAILS ====="
            for f in prep_daily_log.txt batter_log.txt pitcher_log.txt game_scores_log.txt; do
              echo "--- ${f%.*} (tail) ---"
              if [ -f "summaries/07_final/$f" ]; then tail -n 25 "summaries/07_final/$f"; else echo "(missing)"; fi
              echo
            done
            echo "===== ERROR GREP (from current logs) ====="
            if grep -RniE "error|fail|assert|Slate mismatch|Duplicate .*pairs" summaries/07_final | grep -v summary.txt; then
              echo "(errors found)"; exit_code=1
            else
              echo "(no fatal errors found by grep)"; exit_code=0
            fi
            if [ -s "summaries/07_final/gamescores_bad_games.txt" ]; then
              echo "(warning: bad_games present; incomplete games were dropped)"
            fi
            exit $exit_code
          } > summaries/07_final/summary.txt

      - name: Sweep stray root logs into summaries/07_final
        run: |
          shopt -s nullglob
          mkdir -p summaries/07_final
          for f in log_*.txt *.log; do
            if [ -f "$f" ]; then mv "$f" "summaries/07_final/"; fi
          done

      - name: Commit CSVs + summaries (07)
        if: always()
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/end_chain/final/game_score_projections.csv 2>/dev/null || true
          git add data/end_chain/final/batter_event_probabilities.csv 2>/dev/null || true
          git add data/end_chain/final/pitcher_event_probabilities.csv 2>/dev/null || true
          git add data/_projections/batter_event_probabilities.csv 2>/dev/null || true
          git add data/_projections/pitcher_event_probabilities.csv 2>/dev/null || true
          git add data/_projections/batter_props_projected_final.csv 2>/dev/null || true
          git add data/_projections/batter_props_expanded_final.csv 2>/dev/null || true
          git add data/_projections/pitcher_props_projected_final.csv 2>/dev/null || true
          git add data/end_chain/final/pitcher_props_projected_final.csv 2>/dev/null || true
          git add data/raw/todaysgames_normalized.csv 2>/dev/null || true
          git add data/raw/startingpitchers_with_opp_context.csv 2>/dev/null || true
          git add summaries/07_final/* 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "CI: update final projections and summaries/07_final [$(date -u +'%Y-%m-%dT%H:%M:%SZ')]"
            git pull --rebase origin main || true
            git push origin HEAD:main || true
          else
            echo "No changes to commit."
          fi

  workflow_summary:
    name: "Write overall workflow summary (06–07)"
    needs: final_projections
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Build pipeline-level summary file
        run: |
          mkdir -p summaries
          OUT="summaries/pipeline-projections_summary.txt"
          {
            echo "===== WORKFLOW: Pipeline Projections (06–07) ====="
            echo "generated_at: $(date '+%Y-%m-%d %H:%M:%S %Z')"
            echo
            echo "== 06 Projection Status =="
            if [ -f summaries/06_projection/summary.txt ]; then
              sed -n '1,120p' summaries/06_projection/summary.txt
            else
              echo "(missing: summaries/06_projection/summary.txt)"
            fi
            echo
            echo "== 07 Log Tails =="
            for f in prep_daily_log.txt batter_log.txt pitcher_log.txt game_scores_log.txt; do
              echo "--- ${f%.*} tail ---"
              if [ -f "summaries/07_final/$f" ]; then tail -n 25 "summaries/07_final/$f"; else echo "(missing)"; fi
              echo
            done
            echo "== 07 Errors/BAD GAMES =="
            if [ -f summaries/07_final/gamescores_bad_games.txt ]; then
              cat summaries/07_final/gamescores_bad_games.txt
            else
              echo "(no bad_games log found)"
            fi
          } > "$OUT"

      - name: Commit workflow-level summary
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add summaries/pipeline-projections_summary.txt
          git commit -m "Projections: write pipeline-projections_summary.txt" || echo "No changes to commit"
          git pull --rebase origin main || true
          git push origin HEAD:main || true
